{% extends "dashboard/admin/base.html" %}
{% load static %}

{% block page_title %}Questionnaire Builder{% endblock %}

{% block admin_content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-100">Questionnaire Builder</h1>
        <button onclick="saveQuestionnaire()" class="btn btn-primary">
            <i class="fas fa-save mr-2"></i> Save Questionnaire
        </button>
    </div>

    <!-- Questionnaire Type Selection -->
    <div class="card mb-8">
        <div class="card-body">
            <h3 class="text-xl font-semibold text-gray-100 mb-4">Select Questionnaire Type</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="option-card" onclick="selectQuestionnaireType('medical_history')">
                    <div class="card-header">
                        <i class="fas fa-notes-medical text-blue-500 text-3xl"></i>
                        <h4 class="text-lg font-semibold text-gray-100">Medical History</h4>
                    </div>
                    <p class="text-gray-400">Questions about patient's medical background and conditions</p>
                </div>
                <div class="option-card" onclick="selectQuestionnaireType('family_history')">
                    <div class="card-header">
                        <i class="fas fa-users text-green-500 text-3xl"></i>
                        <h4 class="text-lg font-semibold text-gray-100">Family History</h4>
                    </div>
                    <p class="text-gray-400">Questions about family medical history and genetic conditions</p>
                </div>
                <div class="option-card" onclick="selectQuestionnaireType('mouth_features')">
                    <div class="card-header">
                        <i class="fas fa-tooth text-purple-500 text-3xl"></i>
                        <h4 class="text-lg font-semibold text-gray-100">Features in Mouth</h4>
                    </div>
                    <p class="text-gray-400">Questions about oral health, symptoms, and mouth conditions</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Builder -->
    <div class="card mb-8">
        <div class="card-body">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-100">Questions</h3>
                <button onclick="addQuestion()" class="btn btn-secondary">
                    <i class="fas fa-plus mr-2"></i> Add Question
                </button>
            </div>

            <div id="questionsContainer">
                <!-- Questions will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- Preview -->
    <div class="card">
        <div class="card-body">
            <h3 class="text-xl font-semibold text-gray-100 mb-4">Preview</h3>
            <div id="previewContainer" class="bg-gray-800 rounded-lg p-6">
                <p class="text-gray-400 text-center">Select questionnaire type and add questions to see preview</p>
            </div>
        </div>
    </div>
</div>

<style>
.option-card {
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.option-card:hover {
    border-color: var(--accent-color);
    transform: translateY(-2px);
}

.option-card.selected {
    border-color: var(--accent-color);
    background: rgba(20, 184, 166, 0.1);
}

.card-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.card-header i {
    margin-right: 1rem;
}

.question-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.question-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1rem;
}

.question-type-select {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 0.5rem;
    border-radius: 0.375rem;
    margin-left: 1rem;
}

.options-container {
    margin-top: 1rem;
}

.option-input {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.option-input input {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 0.5rem;
    border-radius: 0.375rem;
    margin-right: 0.5rem;
    flex: 1;
}

.option-input button {
    background: var(--accent-color);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    cursor: pointer;
    margin-left: 0.5rem;
}

.btn-remove {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    cursor: pointer;
    font-size: 0.875rem;
}

.grid {
    display: grid;
}

.grid-cols-1 {
    grid-template-columns: repeat(1, minmax(0, 1fr));
}

.md\:grid-cols-3 {
    grid-template-columns: repeat(3, minmax(0, 1fr));
}

.gap-4 {
    gap: 1rem;
}

.justify-between {
    justify-content: space-between;
}

.items-center {
    align-items: center;
}

.flex {
    display: flex;
}

.mb-1 {
    margin-bottom: 0.25rem;
}

.mb-4 {
    margin-bottom: 1rem;
}

.mb-6 {
    margin-bottom: 1.5rem;
}

.mb-8 {
    margin-bottom: 2rem;
}

.mr-1 {
    margin-right: 0.25rem;
}

.mr-2 {
    margin-right: 0.5rem;
}

.mr-3 {
    margin-right: 0.75rem;
}

.ml-1 {
    margin-left: 0.25rem;
}

.mt-1 {
    margin-top: 0.25rem;
}

.p-6 {
    padding: 1.5rem;
}

.text-gray-100 {
    color: #f3f4f6;
}

.text-gray-400 {
    color: #9ca3af;
}

.text-lg {
    font-size: 1.125rem;
}

.text-xl {
    font-size: 1.25rem;
}

.text-3xl {
    font-size: 1.875rem;
}

.font-semibold {
    font-weight: 600;
}

.rounded-lg {
    border-radius: 0.5rem;
}

.text-center {
    text-align: center;
}

@media (max-width: 768px) {
    .md\:grid-cols-3 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
    }
}
</style>

<script>
let questionnaireData = {
    type: null,
    questions: []
};

function selectQuestionnaireType(type) {
    questionnaireData.type = type;
    
    // Update UI
    document.querySelectorAll('.option-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    updatePreview();
}

function addQuestion() {
    if (!questionnaireData.type) {
        alert('Please select a questionnaire type first');
        return;
    }
    
    const questionId = Date.now();
    const question = {
        id: questionId,
        text: '',
        type: 'text',
        options: ['']
    };
    
    questionnaireData.questions.push(question);
    renderQuestion(question);
    updatePreview();
}

function renderQuestion(question) {
    const container = document.getElementById('questionsContainer');
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-item';
    questionDiv.id = `question-${question.id}`;
    
    questionDiv.innerHTML = `
        <div class="question-header">
            <input type="text" placeholder="Enter your question" value="${question.text}" 
                   onchange="updateQuestionText(${question.id}, this.value)"
                   style="background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 0.5rem; border-radius: 0.375rem; flex: 1;">
            <select class="question-type-select" onchange="updateQuestionType(${question.id}, this.value)">
                <option value="text" ${question.type === 'text' ? 'selected' : ''}>Text Options</option>
                <option value="image" ${question.type === 'image' ? 'selected' : ''}>Image Options</option>
                <option value="file" ${question.type === 'file' ? 'selected' : ''}>File Upload</option>
            </select>
            <button class="btn-remove" onclick="removeQuestion(${question.id})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="options-container" id="options-${question.id}">
            ${renderOptions(question)}
        </div>
    `;
    
    container.appendChild(questionDiv);
}

function renderOptions(question) {
    if (question.type === 'file') {
        return '<p class="text-gray-400">File upload question - no options needed</p>';
    }
    
    let optionsHtml = '';
    question.options.forEach((option, index) => {
        const placeholder = question.type === 'image' ? 'Enter option text or upload image' : 'Enter option text';
        optionsHtml += `
            <div class="option-input">
                <input type="text" placeholder="${placeholder}" value="${option}" 
                       onchange="updateOption(${question.id}, ${index}, this.value)">
                ${question.type === 'image' ? `<input type="file" accept="image/*" onchange="updateOptionImage(${question.id}, ${index}, this)">` : ''}
                <button onclick="removeOption(${question.id}, ${index})">Remove</button>
            </div>
        `;
    });
    
    optionsHtml += `
        <button onclick="addOption(${question.id})" class="btn btn-secondary" style="margin-top: 0.5rem;">
            <i class="fas fa-plus mr-2"></i> Add Option
        </button>
    `;
    
    return optionsHtml;
}

function updateQuestionText(questionId, text) {
    const question = questionnaireData.questions.find(q => q.id === questionId);
    if (question) {
        question.text = text;
        updatePreview();
    }
}

function updateQuestionType(questionId, type) {
    const question = questionnaireData.questions.find(q => q.id === questionId);
    if (question) {
        question.type = type;
        if (type === 'file') {
            question.options = [];
        } else if (question.options.length === 0) {
            question.options = [''];
        }
        
        // Re-render the options
        const optionsContainer = document.getElementById(`options-${questionId}`);
        optionsContainer.innerHTML = renderOptions(question);
        updatePreview();
    }
}

function updateOption(questionId, optionIndex, value) {
    const question = questionnaireData.questions.find(q => q.id === questionId);
    if (question && question.options[optionIndex] !== undefined) {
        question.options[optionIndex] = value;
        updatePreview();
    }
}

function updateOptionImage(questionId, optionIndex, input) {
    const question = questionnaireData.questions.find(q => q.id === questionId);
    if (question && question.options[optionIndex] !== undefined) {
        // In a real implementation, you'd upload the file and store the URL
        // For now, we'll just store the filename
        question.options[optionIndex] = input.files[0]?.name || '';
        updatePreview();
    }
}

function addOption(questionId) {
    const question = questionnaireData.questions.find(q => q.id === questionId);
    if (question) {
        question.options.push('');
        
        // Re-render the options
        const optionsContainer = document.getElementById(`options-${questionId}`);
        optionsContainer.innerHTML = renderOptions(question);
        updatePreview();
    }
}

function removeOption(questionId, optionIndex) {
    const question = questionnaireData.questions.find(q => q.id === questionId);
    if (question && question.options.length > 1) {
        question.options.splice(optionIndex, 1);
        
        // Re-render the options
        const optionsContainer = document.getElementById(`options-${questionId}`);
        optionsContainer.innerHTML = renderOptions(question);
        updatePreview();
    }
}

function removeQuestion(questionId) {
    questionnaireData.questions = questionnaireData.questions.filter(q => q.id !== questionId);
    document.getElementById(`question-${questionId}`).remove();
    updatePreview();
}

function updatePreview() {
    const previewContainer = document.getElementById('previewContainer');
    
    if (!questionnaireData.type) {
        previewContainer.innerHTML = '<p class="text-gray-400 text-center">Select questionnaire type and add questions to see preview</p>';
        return;
    }
    
    let previewHtml = `
        <h4 class="text-lg font-semibold text-gray-100 mb-4">
            ${questionnaireData.type === 'medical_history' ? 'Medical History' : 
              questionnaireData.type === 'family_history' ? 'Family History' : 'Features in Mouth'} Questionnaire
        </h4>
    `;
    
    if (questionnaireData.questions.length === 0) {
        previewHtml += '<p class="text-gray-400">No questions added yet</p>';
    } else {
        questionnaireData.questions.forEach((question, index) => {
            previewHtml += `
                <div class="mb-6">
                    <p class="text-gray-100 font-medium mb-2">${index + 1}. ${question.text || 'Untitled question'}</p>
                    <div class="ml-4">
            `;
            
            if (question.type === 'file') {
                previewHtml += '<p class="text-gray-400">[File upload field]</p>';
            } else {
                question.options.forEach((option, optionIndex) => {
                    if (option) {
                        if (question.type === 'image') {
                            previewHtml += `
                                <div class="flex items-center mb-2">
                                    <input type="radio" name="preview_q_${question.id}" class="mr-2">
                                    <span class="text-gray-300">${option}</span>
                                    ${option.includes('.') ? '<span class="text-gray-500 text-sm ml-2">(Image)</span>' : ''}
                                </div>
                            `;
                        } else {
                            previewHtml += `
                                <div class="flex items-center mb-2">
                                    <input type="radio" name="preview_q_${question.id}" class="mr-2">
                                    <span class="text-gray-300">${option}</span>
                                </div>
                            `;
                        }
                    }
                });
            }
            
            previewHtml += '</div></div>';
        });
    }
    
    previewContainer.innerHTML = previewHtml;
}

function saveQuestionnaire() {
    if (!questionnaireData.type) {
        alert('Please select a questionnaire type');
        return;
    }
    
    if (questionnaireData.questions.length === 0) {
        alert('Please add at least one question');
        return;
    }
    
    // Validate questions
    for (let question of questionnaireData.questions) {
        if (!question.text.trim()) {
            alert('Please fill in all question texts');
            return;
        }
        
        if (question.type !== 'file' && question.options.filter(opt => opt.trim()).length < 2) {
            alert('Each question must have at least 2 options');
            return;
        }
    }
    
    // In a real implementation, you'd send this to the server
    console.log('Saving questionnaire:', questionnaireData);
    alert('Questionnaire saved successfully!');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
});
</script>
{% endblock %}
