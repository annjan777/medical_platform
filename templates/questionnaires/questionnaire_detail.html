{% extends "dashboard/admin/base.html" %}

{% block page_title %}Questionnaire{% endblock %}

{% block admin_content %}
<div class="card">
  <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
    <h2 style="margin:0;">{{ questionnaire.title }} (v{{ questionnaire.version }})</h2>
    <div>
      <a class="btn btn-secondary" href="{% url 'questionnaires:builder_edit' questionnaire.pk %}">Edit</a>
      <a class="btn btn-primary" href="{% url 'questionnaires:question_create' questionnaire.pk %}">Add question</a>
    </div>
  </div>
  <div class="card-body">
    <p><strong>Status:</strong> {{ questionnaire.get_status_display }}</p>
    <p><strong>Type:</strong> {{ questionnaire.get_questionnaire_type_display }}</p>
    <p>{{ questionnaire.description }}</p>

    <h3>Questions</h3>
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Question Text</th>
          <th>Type</th>
          <th>Required</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="questions-tbody">
        {% for q in questions %}
          <tr data-question-id="{{ q.pk }}">
            <td>{{ q.order }}</td>
            <td>{{ q.question_text }}</td>
            <td>{{ q.get_question_type_display }}</td>
            <td>{{ q.is_required|yesno:"Yes,No" }}</td>
            <td style="white-space:nowrap;">
              <a href="{% url 'questionnaires:question_update' q.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
              <a href="{% url 'questionnaires:question_delete' q.pk %}" class="btn btn-sm btn-outline-danger">Delete</a>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary move-up" {% if forloop.first %}disabled{% endif %}>
                  <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary move-down" {% if forloop.last %}disabled{% endif %}>
                  <i class="fas fa-arrow-down"></i>
                </button>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5">No questions yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.getElementById('questions-tbody');
    
    tbody.addEventListener('click', function(e) {
        if (e.target.closest('.move-up') || e.target.closest('.move-down')) {
            const button = e.target.closest('button');
            const row = button.closest('tr');
            const isMovingUp = button.classList.contains('move-up');
            
            if (isMovingUp) {
                const prevRow = row.previousElementSibling;
                if (prevRow && prevRow.tagName === 'TR') {
                    tbody.insertBefore(row, prevRow);
                }
            } else {
                const nextRow = row.nextElementSibling;
                if (nextRow && nextRow.tagName === 'TR') {
                    tbody.insertBefore(nextRow, row);
                }
            }
            
            updateQuestionOrder();
            updateButtonStates();
        }
    });
    
    function updateQuestionOrder() {
        const rows = tbody.querySelectorAll('tr[data-question-id]');
        const questionIds = [];
        
        rows.forEach((row, index) => {
            const questionId = row.dataset.questionId;
            questionIds.push(questionId);
            
            // Update the order number display
            const orderCell = row.querySelector('td:first-child');
            orderCell.textContent = index + 1;
        });
        
        // Send the new order to the server
        fetch(`/questionnaires/api/update-question-order/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                question_ids: questionIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Failed to update question order:', data.error);
                // Optionally show an error message to the user
            }
        })
        .catch(error => {
            console.error('Error updating question order:', error);
        });
    }
    
    function updateButtonStates() {
        const rows = tbody.querySelectorAll('tr[data-question-id]');
        
        rows.forEach((row, index) => {
            const upButton = row.querySelector('.move-up');
            const downButton = row.querySelector('.move-down');
            
            // Disable up button for first row
            if (upButton) {
                upButton.disabled = index === 0;
            }
            
            // Disable down button for last row
            if (downButton) {
                downButton.disabled = index === rows.length - 1;
            }
        });
    }
    
    // CSRF token helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}

