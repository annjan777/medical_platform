{% extends "base/base.html" %}
{% load static %}

{% block title %}{{ questionnaire.title }}{% endblock %}

{% block content %}
<div class="questionnaire-container">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Header -->
        <div class="questionnaire-header bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1>{{ questionnaire.title }}</h1>
            {% if questionnaire.description %}
                <p>{{ questionnaire.description }}</p>
            {% endif %}
        </div>

        <!-- Questions Form -->
        <form id="questionnaireForm" method="post" action="{% url 'questionnaires:questionnaire_start' questionnaire.pk %}" class="space-y-6" enctype="multipart/form-data">
            {% csrf_token %}
            {% for question in questions %}
            <div class="question-container" data-question-id="{{ question.id }}" data-question-order="{{ forloop.counter0 }}">
                <h3>
                    {{ forloop.counter }}. {{ question.question_text }}
                    {% if question.is_required %}<span class="required">*</span>{% endif %}
                </h3>

                <!-- Yes/No Question -->
                {% if question.question_type == 'yes_no' %}
                <div>
                    <label class="option-label">
                        <input type="radio" name="question_{{ question.id }}" value="yes" {% if question.is_required %}required{% endif %}>
                        <div class="option-content">
                            <span class="option-text">Yes</span>
                        </div>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="question_{{ question.id }}" value="no" {% if question.is_required %}required{% endif %}>
                        <div class="option-content">
                            <span class="option-text">No</span>
                        </div>
                    </label>
                </div>

                <!-- True/False Question -->
                {% elif question.question_type == 'true_false' %}
                <div>
                    <label class="option-label">
                        <input type="radio" name="question_{{ question.id }}" value="true" {% if question.is_required %}required{% endif %}>
                        <div class="option-content">
                            <span class="option-text">True</span>
                        </div>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="question_{{ question.id }}" value="false" {% if question.is_required %}required{% endif %}>
                        <div class="option-content">
                            <span class="option-text">False</span>
                        </div>
                    </label>
                </div>

                <!-- Multiple Choice Question -->
                {% elif question.question_type == 'multiple_choice' %}
                <div>
                    {% for option in question.options.all %}
                    <label class="option-label">
                        <input type="radio" name="question_{{ question.id }}" value="{{ option.id }}" {% if question.is_required %}required{% endif %}>
                        <div class="option-content">
                            {% if option.option_image %}
                            <div>
                                <img src="{{ option.option_image.url }}" alt="{{ option.text|default:option.id }}" class="option-image">
                                {% if option.text %}
                                <p class="option-image-caption">{{ option.text }}</p>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="option-text">{{ option.text }}</span>
                            {% endif %}
                        </div>
                    </label>
                    {% empty %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No options available for this question. Please add options in the questionnaire builder.
                    </div>
                    {% endfor %}
                </div>

                <!-- Short Answer Question -->
                {% elif question.question_type == 'short_answer' %}
                <div>
                    <textarea name="question_{{ question.id }}" 
                              class="form-textarea"
                              placeholder="Enter your answer here..."
                              {% if question.is_required %}required{% endif %}></textarea>
                </div>

                <!-- Attachment Question -->
                {% elif question.question_type == 'attachment' %}
                <div>
                    <div class="file-upload-area">
                        <div>
                            <input id="question_{{ question.id }}" 
                                   name="question_{{ question.id }}" 
                                   type="file" 
                                   accept=".pdf,.xls,.xlsx,.csv,.txt,.doc,.docx,.jpg,.jpeg,.png,.gif,.bmp"
                                   {% if question.is_required %}required{% endif %}>
                        </div>
                        <p class="file-upload-info">PDF, XLS, CSV, TXT, DOC, Images (max 10MB)</p>
                        <p class="file-status success" id="file-name-{{ question.id }}"></p>
                        <p class="file-status error" id="file-error-{{ question.id }}"></p>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}

            <!-- Submit Button -->
            <div class="text-center mt-6">
                <button type="submit" class="btn-submit">
                    <i class="fas fa-check me-2"></i>Submit Questionnaire
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentQuestionIndex = 0;
const totalQuestions = {{ questions.count }};
const questionContainers = document.querySelectorAll('.question-container');

function showQuestion(index) {
    // Hide all questions
    questionContainers.forEach(container => {
        container.style.display = 'none';
    });
    
    // Show current question
    questionContainers[index].style.display = 'block';
    
    // Update progress
    const progress = ((index + 1) / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('currentQuestion').textContent = index + 1;
    
    // Update buttons
    document.getElementById('prevBtn').disabled = index === 0;
    
    if (index === totalQuestions - 1) {
        document.getElementById('nextBtn').classList.add('hidden');
        document.getElementById('submitBtn').classList.remove('hidden');
    } else {
        document.getElementById('nextBtn').classList.remove('hidden');
        document.getElementById('submitBtn').classList.add('hidden');
    }
}

function nextQuestion() {
    if (currentQuestionIndex < totalQuestions - 1) {
        currentQuestionIndex++;
        showQuestion(currentQuestionIndex);
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuestion(currentQuestionIndex);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // File validation functions
    window.showError = function(inputId, message) {
        const questionContainer = document.querySelector(`[data-question-id="${inputId.replace('question_', '')}"]`);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'file-error mt-2 p-2 bg-red-100 border border-red-400 text-red-700 rounded text-sm';
        errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
        questionContainer.appendChild(errorDiv);
        
        // Auto-remove error after 5 seconds
        setTimeout(function() {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    };
    
    window.isAllowedExtension = function(filename) {
        const allowedExtensions = ['.pdf', '.xls', '.xlsx', '.csv', '.txt', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.gif', '.bmp'];
        const extension = filename.toLowerCase().substring(filename.lastIndexOf('.'));
        return allowedExtensions.includes(extension);
    };
    
    // Handle file upload functionality
    const attachmentQuestions = document.querySelectorAll('[data-question-id]');
    attachmentQuestions.forEach(container => {
        const questionId = container.dataset.questionId;
        const fileInput = document.getElementById(`question_${questionId}`);
        const statusMessage = document.getElementById(`file-name-${questionId}`);
        const errorMessage = document.getElementById(`file-error-${questionId}`);
        
        if (fileInput) {
            // Add event listener for file selection (no separate upload button needed)
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                
                if (file) {
                    // Validate file size (10MB limit)
                    const maxSize = 10 * 1024 * 1024; // 10MB in bytes
                    if (file.size > maxSize) {
                        errorMessage.textContent = `❌ File "${file.name}" is too large (${(file.size/1024/1024).toFixed(1)}MB). Maximum size is 10MB.`;
                        errorMessage.style.color = 'red';
                        statusMessage.textContent = '';
                        fileInput.value = ''; // Clear the file
                        return;
                    }
                    
                    // Validate file type
                    const allowedTypes = ['application/pdf', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                                      'text/csv', 'text/plain', 'application/msword', 
                                      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                      'image/jpeg', 'image/png', 'image/gif', 'image/bmp'];
                    
                    if (!allowedTypes.includes(file.type) && !isAllowedExtension(file.name)) {
                        errorMessage.textContent = `❌ File "${file.name}" has invalid format. Allowed: PDF, XLS, XLSX, CSV, TXT, DOC, DOCX, JPG, PNG, GIF, BMP`;
                        errorMessage.style.color = 'red';
                        statusMessage.textContent = '';
                        fileInput.value = ''; // Clear the file
                        return;
                    }
                    
                    // Show success message
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    statusMessage.textContent = `✅ ${file.name} (${fileSize}MB) ready to upload`;
                    statusMessage.style.color = 'green';
                    errorMessage.textContent = '';
                } else {
                    statusMessage.textContent = '';
                    errorMessage.textContent = '';
                }
            });
        }
    });
});

// Form submission
document.getElementById('questionnaireForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';
    }
    
    // Submit the form normally
    this.submit();
});
</script>

<style>
/* Professional Business Styling */
.questionnaire-container {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #ffffff;
    color: #333333;
}

.questionnaire-header h1 {
    font-size: 2rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.questionnaire-header p {
    font-size: 1rem;
    color: #6c757d;
    margin-bottom: 0;
}

.question-container {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 2rem;
    margin-bottom: 2rem;
    background: #ffffff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.question-container h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 1.5rem;
    line-height: 1.4;
}

.question-container .required {
    color: #dc3545;
    font-weight: 600;
}

/* Option styling */
.option-label {
    display: block;
    padding: 1rem;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background: #ffffff;
}

.option-label:hover {
    border-color: #22c55e;
    background: #f8fff9;
}

.option-label input[type="radio"]:checked + .option-content {
    color: #22c55e;
    font-weight: 500;
}

.option-label input[type="radio"]:checked {
    accent-color: #22c55e;
}

.option-content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.option-text {
    font-size: 1rem;
    color: #495057;
    margin: 0;
}

/* Image option styling */
.option-image {
    max-height: 120px;
    max-width: 200px;
    border-radius: 4px;
    object-fit: contain;
    border: 1px solid #dee2e6;
    display: block;
    margin: 0.5rem 0;
}

.option-image-caption {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.5rem;
    margin-bottom: 0;
}

/* Textarea styling */
.form-textarea {
    border: 2px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem;
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.2s ease;
    resize: vertical;
    min-height: 100px;
}

.form-textarea:focus {
    outline: none;
    border-color: #22c55e;
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
}

/* File upload styling */
.file-upload-area {
    border: 2px dashed #22c55e;
    border-radius: 6px;
    padding: 2rem;
    text-align: center;
    background: #f8fff9;
    transition: all 0.2s ease;
}

.file-upload-area:hover {
    border-color: #16a34a;
    background: #f0fdf4;
}

.file-upload-area input[type="file"] {
    border: none;
    padding: 0.5rem;
    font-size: 0.875rem;
}

.file-upload-info {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.5rem;
}

.file-status {
    font-size: 0.75rem;
    margin-top: 0.5rem;
    font-weight: 500;
}

.file-status.success {
    color: #22c55e;
}

.file-status.error {
    color: #dc3545;
}

/* Submit button styling */
.btn-submit {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 6px;
    font-size: 1.125rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 6px rgba(34, 197, 94, 0.2);
}

.btn-submit:hover {
    background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
    transform: translateY(-1px);
    box-shadow: 0 6px 8px rgba(34, 197, 94, 0.3);
}

.btn-submit:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Responsive design */
@media (max-width: 768px) {
    .question-container {
        padding: 1.5rem;
    }
    
    .questionnaire-header h1 {
        font-size: 1.75rem;
    }
    
    .option-image {
        max-height: 100px;
        max-width: 150px;
    }
    
    .option-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
}
</style>
{% endblock %}
