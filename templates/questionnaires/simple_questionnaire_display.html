{% extends "base/base.html" %}
{% load static %}

{% block title %}{{ questionnaire.title }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ questionnaire.title }}</h1>
            {% if questionnaire.description %}
                <p class="text-gray-600">{{ questionnaire.description }}</p>
            {% endif %}
        </div>

        <!-- Questions Form -->
        <form id="questionnaireForm" method="post" action="{% url 'questionnaires:questionnaire_start' questionnaire.pk %}" class="space-y-6" enctype="multipart/form-data">
            {% csrf_token %}
            {% for question in questions %}
            <div class="question-container bg-white rounded-lg shadow-sm p-6" data-question-id="{{ question.id }}" data-question-order="{{ forloop.counter0 }}">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">
                        {{ forloop.counter }}. {{ question.question_text }}
                        {% if question.is_required %}<span class="text-red-500">*</span>{% endif %}
                    </h3>
                </div>

                <!-- Yes/No Question -->
                {% if question.question_type == 'yes_no' %}
                <div class="space-y-3">
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="question_{{ question.id }}" value="yes" class="mr-3" {% if question.is_required %}required{% endif %}>
                        <span class="text-gray-700">Yes</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="question_{{ question.id }}" value="no" class="mr-3" {% if question.is_required %}required{% endif %}>
                        <span class="text-gray-700">No</span>
                    </label>
                </div>

                <!-- True/False Question -->
                {% elif question.question_type == 'true_false' %}
                <div class="space-y-3">
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="question_{{ question.id }}" value="true" class="mr-3" {% if question.is_required %}required{% endif %}>
                        <span class="text-gray-700">True</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="question_{{ question.id }}" value="false" class="mr-3" {% if question.is_required %}required{% endif %}>
                        <span class="text-gray-700">False</span>
                    </label>
                </div>

                <!-- Multiple Choice Question -->
                {% elif question.question_type == 'multiple_choice' %}
                <div class="space-y-3">
                    {% for option in question.options.all %}
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="question_{{ question.id }}" value="{{ option.id }}" class="mr-3" {% if question.is_required %}required{% endif %}>
                        
                        {% if option.option_image %}
                        <div class="flex-1">
                            <img src="{{ option.option_image.url }}" alt="{{ option.text|default:option.id }}" 
                                 class="max-h-32 max-w-full object-contain rounded">
                            {% if option.text %}
                            <p class="mt-2 text-sm text-gray-600">{{ option.text }}</p>
                            {% endif %}
                        </div>
                        {% else %}
                        <span class="text-gray-700">{{ option.text }}</span>
                        {% endif %}
                    </label>
                    {% endfor %}
                </div>

                <!-- Short Answer Question -->
                {% elif question.question_type == 'short_answer' %}
                <div>
                    <textarea name="question_{{ question.id }}" 
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              rows="3" 
                              placeholder="Enter your answer here..."
                              {% if question.is_required %}required{% endif %}></textarea>
                </div>

                <!-- Attachment Question -->
                {% elif question.question_type == 'attachment' %}
                <div>
                    <div class="border-2 border-dashed border-blue-300 rounded-lg p-4 hover:border-blue-400 transition-colors bg-blue-50 hover:bg-blue-100">
                        <div class="text-center">
                            <div class="mb-2">
                                <input id="question_{{ question.id }}" 
                                       name="question_{{ question.id }}" 
                                       type="file" 
                                       class="form-control"
                                       accept=".pdf,.xls,.xlsx,.csv,.txt,.doc,.docx,.jpg,.jpeg,.png,.gif,.bmp"
                                       {% if question.is_required %}required{% endif %}>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">PDF, XLS, CSV, TXT, DOC, Images (max 10MB)</p>
                            <p class="mt-2 text-xs text-green-600 font-medium" id="file-name-{{ question.id }}"></p>
                            <p class="mt-2 text-xs text-red-600 font-medium" id="file-error-{{ question.id }}"></p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}

            <!-- Submit Button -->
            <div class="text-center mt-6">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium text-lg transition-colors">
                    <i class="fas fa-check mr-2"></i>Submit Questionnaire
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentQuestionIndex = 0;
const totalQuestions = {{ questions.count }};
const questionContainers = document.querySelectorAll('.question-container');

function showQuestion(index) {
    // Hide all questions
    questionContainers.forEach(container => {
        container.style.display = 'none';
    });
    
    // Show current question
    questionContainers[index].style.display = 'block';
    
    // Update progress
    const progress = ((index + 1) / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('currentQuestion').textContent = index + 1;
    
    // Update buttons
    document.getElementById('prevBtn').disabled = index === 0;
    
    if (index === totalQuestions - 1) {
        document.getElementById('nextBtn').classList.add('hidden');
        document.getElementById('submitBtn').classList.remove('hidden');
    } else {
        document.getElementById('nextBtn').classList.remove('hidden');
        document.getElementById('submitBtn').classList.add('hidden');
    }
}

function nextQuestion() {
    if (currentQuestionIndex < totalQuestions - 1) {
        currentQuestionIndex++;
        showQuestion(currentQuestionIndex);
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuestion(currentQuestionIndex);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // File validation functions
    window.showError = function(inputId, message) {
        const questionContainer = document.querySelector(`[data-question-id="${inputId.replace('question_', '')}"]`);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'file-error mt-2 p-2 bg-red-100 border border-red-400 text-red-700 rounded text-sm';
        errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
        questionContainer.appendChild(errorDiv);
        
        // Auto-remove error after 5 seconds
        setTimeout(function() {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    };
    
    window.isAllowedExtension = function(filename) {
        const allowedExtensions = ['.pdf', '.xls', '.xlsx', '.csv', '.txt', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.gif', '.bmp'];
        const extension = filename.toLowerCase().substring(filename.lastIndexOf('.'));
        return allowedExtensions.includes(extension);
    };
    
    // Handle file upload functionality
    const attachmentQuestions = document.querySelectorAll('[data-question-id]');
    attachmentQuestions.forEach(container => {
        const questionId = container.dataset.questionId;
        const fileInput = document.getElementById(`question_${questionId}`);
        const statusMessage = document.getElementById(`file-name-${questionId}`);
        const errorMessage = document.getElementById(`file-error-${questionId}`);
        
        if (fileInput) {
            // Add event listener for file selection (no separate upload button needed)
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                
                if (file) {
                    // Validate file size (10MB limit)
                    const maxSize = 10 * 1024 * 1024; // 10MB in bytes
                    if (file.size > maxSize) {
                        errorMessage.textContent = `❌ File "${file.name}" is too large (${(file.size/1024/1024).toFixed(1)}MB). Maximum size is 10MB.`;
                        errorMessage.style.color = 'red';
                        statusMessage.textContent = '';
                        fileInput.value = ''; // Clear the file
                        return;
                    }
                    
                    // Validate file type
                    const allowedTypes = ['application/pdf', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                                      'text/csv', 'text/plain', 'application/msword', 
                                      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                      'image/jpeg', 'image/png', 'image/gif', 'image/bmp'];
                    
                    if (!allowedTypes.includes(file.type) && !isAllowedExtension(file.name)) {
                        errorMessage.textContent = `❌ File "${file.name}" has invalid format. Allowed: PDF, XLS, XLSX, CSV, TXT, DOC, DOCX, JPG, PNG, GIF, BMP`;
                        errorMessage.style.color = 'red';
                        statusMessage.textContent = '';
                        fileInput.value = ''; // Clear the file
                        return;
                    }
                    
                    // Show success message
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    statusMessage.textContent = `✅ ${file.name} (${fileSize}MB) ready to upload`;
                    statusMessage.style.color = 'green';
                    errorMessage.textContent = '';
                } else {
                    statusMessage.textContent = '';
                    errorMessage.textContent = '';
                }
            });
        }
    });
});

// Form submission
document.getElementById('questionnaireForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';
    }
    
    // Submit the form normally
    this.submit();
});
</script>

<style>
.btn {
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-primary {
    background-color: #3b82f6;
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background-color: #2563eb;
}

.btn-secondary {
    background-color: #6b7280;
    color: white;
}

.btn-secondary:hover:not(:disabled) {
    background-color: #4b5563;
}

.btn-success {
    background-color: #10b981;
    color: white;
}

.btn-success:hover {
    background-color: #059669;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
{% endblock %}
