{% extends "base/base.html" %}
{% load static %}

{% block title %}{{ questionnaire.title }}{% endblock %}

{% block content %}
<div class="questionnaire-container">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Header -->
        <div class="questionnaire-header bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1>{{ questionnaire.title }}</h1>
            {% if questionnaire.description %}
            <p>{{ questionnaire.description }}</p>
            {% endif %}
        </div>

        <!-- Questions Form -->
        <form id="questionnaireForm" method="post"
            action="{% url 'questionnaires:questionnaire_start' questionnaire.pk %}" class="space-y-6"
            enctype="multipart/form-data">
            {% csrf_token %}
            {% for question in questions %}
            <div class="question-container form-group card border-0 shadow-sm mb-4" data-question-id="{{ question.id }}"
                data-question-order="{{ forloop.counter0 }}" {% if question.parent %}
                data-parent-id="{{ question.parent.id }}" data-trigger-answer="{{ question.trigger_answer }}"
                style="display: none;" {% endif %}>

                <div class="card-body p-4">
                    <h5 class="question-text mb-4">
                        <span class="badge bg-primary me-2">{{ question.get_display_number }}</span>
                        {{ question.question_text }}
                        {% if question.is_required %}<span class="text-danger ms-1">*</span>{% endif %}
                    </h5>

                    <!-- Yes/No Question -->
                    {% if question.question_type == 'yes_no' %}
                    <div class="radio-group ms-2">
                        <div class="form-check mb-3">
                            <input class="form-check-input custom-radio" type="radio" name="question_{{ question.id }}"
                                id="q{{ question.id }}_yes" value="yes" {{ question.is_required|yesno:'required,' }}>
                            <label class="form-check-label radio-label fs-5" for="q{{ question.id }}_yes">
                                Yes
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input custom-radio" type="radio" name="question_{{ question.id }}"
                                id="q{{ question.id }}_no" value="no" {{ question.is_required|yesno:'required,' }}>
                            <label class="form-check-label radio-label fs-5" for="q{{ question.id }}_no">
                                No
                            </label>
                        </div>
                    </div>

                    <!-- True/False Question -->
                    {% elif question.question_type == 'true_false' %}
                    <div class="radio-group ms-2">
                        <div class="form-check mb-3">
                            <input class="form-check-input custom-radio" type="radio" name="question_{{ question.id }}"
                                id="q{{ question.id }}_true" value="true" {{ question.is_required|yesno:'required,' }}>
                            <label class="form-check-label radio-label fs-5" for="q{{ question.id }}_true">
                                True
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input custom-radio" type="radio" name="question_{{ question.id }}"
                                id="q{{ question.id }}_false" value="false" {{ question.is_required|yesno:'required,'
                                }}>
                            <label class="form-check-label radio-label fs-5" for="q{{ question.id }}_false">
                                False
                            </label>
                        </div>
                    </div>

                    <!-- Multiple Choice Question -->
                    {% elif question.question_type == 'multiple_choice' %}
                    <div class="radio-group ms-2">
                        {% for option in question.options.all %}
                        <div class="form-check mb-3">
                            <input class="form-check-input custom-radio" type="radio" name="question_{{ question.id }}"
                                id="opt_{{ option.id }}" value="{{ option.id }}" {{
                                question.is_required|yesno:'required,' }}>
                            <label class="form-check-label radio-label fs-5 d-flex align-items-center"
                                for="opt_{{ option.id }}">
                                {% if option.option_image %}
                                <div class="me-3">
                                    <img src="{{ option.option_image.url }}" alt="{{ option.text|default:option.id }}"
                                        class="img-thumbnail" style="max-height: 100px;">
                                    {% if option.text %}
                                    <span class="d-block mt-1 text-muted small">{{ option.text }}</span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span>{{ option.text }}</span>
                                {% endif %}
                            </label>
                        </div>
                        {% empty %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No options available for this question. Please add options in the questionnaire builder.
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Short Answer Question -->
                    {% elif question.question_type == 'short_answer' %}
                    <div class="mt-2">
                        <textarea name="question_{{ question.id }}" class="form-control form-control-lg border-2"
                            rows="3" placeholder="Type your answer here..." {{ question.is_required|yesno:'required,'
                            }}></textarea>
                    </div>

                    <!-- Attachment Question -->
                    {% elif question.question_type == 'attachment' %}
                    <div class="mt-2">
                        <div class="p-4 border-2 border-dashed rounded bg-light text-center">
                            <label for="question_{{ question.id }}"
                                class="form-label text-primary fw-bold cursor-pointer">
                                <i class="fas fa-cloud-upload-alt fa-2x mb-2 d-block"></i>
                                Select a file to upload
                            </label>
                            <input class="form-control d-none" id="question_{{ question.id }}"
                                name="question_{{ question.id }}" type="file"
                                accept=".pdf,.xls,.xlsx,.csv,.txt,.doc,.docx,.jpg,.jpeg,.png,.gif,.bmp" {{
                                question.is_required|yesno:'required,' }}>
                            <div class="text-muted small mt-2">Supported formats: PDF, XLS, CSV, TXT, DOC, Images (max
                                10MB)</div>
                            <div class="mt-3 font-weight-bold text-success" id="file-name-{{ question.id }}"></div>
                            <div class="mt-2 text-danger" id="file-error-{{ question.id }}"></div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <!-- Submit Button -->
                <div class="text-center mt-5 mb-4">
                    <button type="submit" class="btn btn-success btn-lg px-5 py-3 rounded-pill shadow-sm"
                        style="font-size: 1.1rem; letter-spacing: 0.5px;">
                        <i class="fas fa-check-circle me-2"></i> Submit Medical Questionnaire
                    </button>
                </div>
        </form>
    </div>
</div>

<script>
    // We don't use pagination-based showQuestion indexing anymore because of conditional display.
    // Instead, visibility is managed by CSS dynamically.
    // If pagination was intended, logic needs to only show Top-Level questions + triggered children. 
    // For now, simple_questionnaire_display shows all questions by default.

    // We must initialize immediately if loaded via AJAX, or wait for DOM if loaded natively.
    function initQuestionnaireLogic() {
        // Hide all followups initially (already done inline with style="display:none;")
        // Setup event listeners for yes/no questions
        const yesNoInputs = document.querySelectorAll('input[type="radio"][value="yes"], input[type="radio"][value="no"]');

        yesNoInputs.forEach(input => {
            // Remove any old listeners if re-initialized
            const new_element = input.cloneNode(true);
            input.parentNode.replaceChild(new_element, input);

            new_element.addEventListener('change', function (e) {
                handleBranching(e.target);
            });
        });

        function handleBranching(selectedInput) {
            const parentContainer = selectedInput.closest('.question-container');
            if (!parentContainer) return;

            const parentId = parentContainer.dataset.questionId;
            const selectedValue = selectedInput.value; // 'yes' or 'no'

            // Find all immediate follow-ups for this parent
            const childQuestions = document.querySelectorAll(`.question-container[data-parent-id="${parentId}"]`);

            childQuestions.forEach(child => {
                if (child.dataset.triggerAnswer === selectedValue) {
                    // Show triggered child
                    child.style.display = 'block';
                    // Make required inputs active again
                    toggleRequired(child, true);
                } else {
                    // Hide untriggered child and reset its answers
                    hideAndResetBranch(child);
                }
            });
        }

        function hideAndResetBranch(container) {
            container.style.display = 'none';

            // Reset inputs
            const inputs = container.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.type === 'radio' || input.type === 'checkbox') input.checked = false;
                else input.value = '';
            });

            // Disable required validation while hidden
            toggleRequired(container, false);

            // Recursively hide all children of this branch
            const branchId = container.dataset.questionId;
            const branchChildren = document.querySelectorAll(`.question-container[data-parent-id="${branchId}"]`);
            branchChildren.forEach(child => hideAndResetBranch(child));
        }

        function toggleRequired(container, isRequired) {
            const inputs = container.querySelectorAll('input[required], textarea[required], select[required]');
            // To manage dynamic required state safely:
            // Assume if it has a 'required' span, it should be required when visible
            const hasRequiredMarker = container.querySelector('.required') !== null;
            if (hasRequiredMarker) {
                const allInputs = container.querySelectorAll('input, textarea, select');
                allInputs.forEach(input => {
                    input.required = isRequired;
                });
            }
        }

        // Previous pagination logic removed as it conflicts with branching flow.
        // Ensure the submit button is always visible.
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) submitBtn.classList.remove('hidden');

        // File validation functions
        window.showError = function (inputId, message) {
            const questionContainer = document.querySelector(`[data-question-id="${inputId.replace('question_', '')}"]`);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'file-error mt-2 p-2 bg-red-100 border border-red-400 text-red-700 rounded text-sm';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
            questionContainer.appendChild(errorDiv);

            // Auto-remove error after 5 seconds
            setTimeout(function () {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        };

        window.isAllowedExtension = function (filename) {
            const allowedExtensions = ['.pdf', '.xls', '.xlsx', '.csv', '.txt', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.gif', '.bmp'];
            const extension = filename.toLowerCase().substring(filename.lastIndexOf('.'));
            return allowedExtensions.includes(extension);
        };

        // Handle file upload functionality
        const attachmentQuestions = document.querySelectorAll('[data-question-id]');
        attachmentQuestions.forEach(container => {
            const questionId = container.dataset.questionId;
            const fileInput = document.getElementById(`question_${questionId}`);
            const statusMessage = document.getElementById(`file-name-${questionId}`);
            const errorMessage = document.getElementById(`file-error-${questionId}`);

            if (fileInput) {
                // Add event listener for file selection (no separate upload button needed)
                fileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];

                    if (file) {
                        // Validate file size (10MB limit)
                        const maxSize = 10 * 1024 * 1024; // 10MB in bytes
                        if (file.size > maxSize) {
                            errorMessage.textContent = `❌ File "${file.name}" is too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Maximum size is 10MB.`;
                            errorMessage.style.color = 'red';
                            statusMessage.textContent = '';
                            fileInput.value = ''; // Clear the file
                            return;
                        }

                        // Validate file type
                        const allowedTypes = ['application/pdf', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                            'text/csv', 'text/plain', 'application/msword',
                            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                            'image/jpeg', 'image/png', 'image/gif', 'image/bmp'];

                        if (!allowedTypes.includes(file.type) && !isAllowedExtension(file.name)) {
                            errorMessage.textContent = `❌ File "${file.name}" has invalid format. Allowed: PDF, XLS, XLSX, CSV, TXT, DOC, DOCX, JPG, PNG, GIF, BMP`;
                            errorMessage.style.color = 'red';
                            statusMessage.textContent = '';
                            fileInput.value = ''; // Clear the file
                            return;
                        }

                        // Show success message
                        const fileSize = (file.size / 1024 / 1024).toFixed(2);
                        statusMessage.textContent = `✅ ${file.name} (${fileSize}MB) ready to upload`;
                        statusMessage.style.color = 'green';
                        errorMessage.textContent = '';
                    } else {
                        statusMessage.textContent = '';
                        errorMessage.textContent = '';
                    }
                });
            }
        });
    }

    // Run initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initQuestionnaireLogic);
    } else {
        // Run immediately since the DOM is already ready (e.g. loaded via AJAX via innerHTML)
        // Set a small timeout to ensure the browser has finished rendering the injected DOM nodes
        setTimeout(initQuestionnaireLogic, 50);
    }

    // Form submission
    document.getElementById('questionnaireForm').addEventListener('submit', function (e) {
        e.preventDefault();

        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';
        }

        // Submit the form normally
        this.submit();
    });
</script>

<style>
    /* Clean Medical Platform Theme Tweaks */
    .questionnaire-container {
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    .custom-radio {
        width: 1.3rem;
        height: 1.3rem;
        margin-top: 0.2rem;
        cursor: pointer;
    }

    .radio-label {
        cursor: pointer;
        color: #344767;
    }

    .question-text {
        font-weight: 600;
        color: #2b3a4a;
        line-height: 1.4;
    }

    .border-dashed {
        border-style: dashed !important;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .question-container {
        transition: all 0.3s ease;
    }

    .question-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .08) !important;
    }
</style>
{% endblock %}