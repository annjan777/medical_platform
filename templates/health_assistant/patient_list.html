{% extends 'health_assistant/base_clean.html' %}
{% load static %}

{% block title %}Patient Management - Health Assistant{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">
                    <i class="fas fa-users me-2"></i>Patient Management
                </h4>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshPatients()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Search Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <form id="searchForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="searchInput" class="form-label">Search Patients</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="Search by name, ID, or phone..." 
                                       value="{{ request.GET.q|default:'' }}">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="genderFilter" class="form-label">Gender</label>
                            <select class="form-select" id="genderFilter">
                                <option value="">All Genders</option>
                                <option value="M" {% if request.GET.gender == 'M' %}selected{% endif %}>Male</option>
                                <option value="F" {% if request.GET.gender == 'F' %}selected{% endif %}>Female</option>
                                <option value="O" {% if request.GET.gender == 'O' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="dateFrom" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="dateFrom" 
                                   value="{{ request.GET.date_from|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="dateTo" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="dateTo" 
                                   value="{{ request.GET.date_to|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>Search
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Section -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <span id="patientCount">Loading patients...</span>
                        </h6>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="exportPatients()">
                                <i class="fas fa-download me-1"></i>Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Patients Table -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="patientsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Patient ID</th>
                                    <th>Name</th>
                                    <th>Age</th>
                                    <th>Gender</th>
                                    <th>Phone</th>
                                    <th>City</th>
                                    <th>Registered</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="patientsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2">Loading patients...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Patients pagination" class="mt-3">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination will be populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Patient Modal -->
<div class="modal fade" id="editPatientModal" tabindex="-1" aria-labelledby="editPatientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPatientModalLabel">
                    <i class="fas fa-user-edit me-2"></i>Edit Patient
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPatientForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="editFirstName" name="first_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="editLastName" name="last_name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="editDateOfBirth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="editDateOfBirth" name="date_of_birth">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editGender" class="form-label">Gender</label>
                            <select class="form-select" id="editGender" name="gender" required>
                                <option value="">Select Gender</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="editPhone" name="phone_number">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" name="email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editCity" class="form-label">City</label>
                            <input type="text" class="form-control" id="editCity" name="city">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="editAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="editAddress" name="address" rows="3"></textarea>
                        </div>
                    </div>
                    <input type="hidden" id="editPatientId" name="patient_id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updatePatient()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Patient updated successfully!
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Force refresh to avoid caching issues
const CACHE_BUSTER = new Date().getTime();

let currentPage = 1;
let currentQuery = '';
let currentGender = '';
let currentDateFrom = '';
let currentDateTo = '';

// Load patients on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing patient list...');
    console.log('Current user role check...');
    
    // Test authentication first
    fetch('/health-assistant/api/test-auth/', {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Auth test result:', data);
        
        // If auth works, try simple API call
        if (data.authenticated) {
            fetch('/health-assistant/api/search-patients/?q=test')
                .then(response => response.json())
                .then(data => {
                    console.log('Simple API test:', data);
                })
                .catch(error => {
                    console.error('Simple API test failed:', error);
                });
        }
    })
    .catch(error => {
        console.error('Auth test failed:', error);
    });
    
    // Check if we can access page
    loadPatients();
    
    // Setup search form
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        currentPage = 1;
        loadPatients();
    });
});

function loadPatients() {
    currentQuery = document.getElementById('searchInput').value;
    currentGender = document.getElementById('genderFilter').value;
    currentDateFrom = document.getElementById('dateFrom').value;
    currentDateTo = document.getElementById('dateTo').value;
    
    const params = new URLSearchParams({
        q: currentQuery,
        gender: currentGender,
        date_from: currentDateFrom,
        date_to: currentDateTo,
        page: currentPage
    });
    
    console.log('Loading patients with params:', params.toString());
    
    // Show loading
    document.getElementById('patientsTableBody').innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-2">Loading patients...</div>
            </td>
        </tr>
    `;
    
    const apiUrl = `/health-assistant/api/search-patients/?${params.toString()}`;
    console.log('Making API call to:', apiUrl);
    
    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => {
            console.log('API Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API Response data:', data);
            console.log('Patients array:', data.patients);
            if (data.error) {
                throw new Error(data.error);
            }
            displayPatients(data.patients || []);
            updatePagination(data.pagination || {});
            updatePatientCount(data.total_count || 0);
        })
        .catch(error => {
            console.error('Error loading patients:', error);
            document.getElementById('patientsTableBody').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading patients: ${error.message}
                    </td>
                </tr>
            `;
        });
}

function displayPatients(patients) {
    const tbody = document.getElementById('patientsTableBody');
    
    console.log('Displaying patients:', patients.length);
    
    if (patients.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="fas fa-search me-2"></i>
                    No patients found matching your criteria.
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    patients.forEach((patient, index) => {
        console.log(`Patient ${index}:`, patient);
        
        const firstName = patient.first_name || '';
        const lastName = patient.last_name || '';
        const fullName = firstName + ' ' + lastName;
        const age = patient.age !== null && patient.age !== undefined ? patient.age : '-';
        
        // Generate avatar initials safely
        let avatarInitials = '?';
        if (firstName.length > 0 && lastName.length > 0) {
            avatarInitials = firstName.charAt(0) + lastName.charAt(0);
        } else if (firstName.length > 0) {
            avatarInitials = firstName.charAt(0);
        } else if (lastName.length > 0) {
            avatarInitials = lastName.charAt(0);
        }
        
        html += '<tr>' +
            '<td><span class="badge bg-secondary">' + (patient.patient_id || 'N/A') + '</span></td>' +
            '<td>' +
                '<div class="d-flex align-items-center">' +
                    '<div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">' + avatarInitials + '</div>' +
                    '<div>' +
                        '<div class="fw-semibold">' + fullName + '</div>' +
                        '<small class="text-muted">' + (patient.email || 'No email') + '</small>' +
                    '</div>' +
                '</div>' +
            '</td>' +
            '<td>' + age + '</td>' +
            '<td><span class="badge bg-info text-dark">' + (patient.gender_display || '-') + '</span></td>' +
            '<td><i class="fas fa-phone me-1"></i>' + (patient.phone_number || '-') + '</td>' +
            '<td>' + (patient.city || '-') + '</td>' +
            '<td><small class="text-muted">' + formatDate(patient.created_at) + '</small></td>' +
            '<td>' +
                '<div class="btn-group" role="group">' +
                    '<button type="button" class="btn btn-outline-primary btn-sm" onclick="editPatient(' + patient.id + ')" title="Edit Patient">' +
                        '<i class="fas fa-user-edit"></i>' +
                    '</button>' +
                    '<button type="button" class="btn btn-outline-success btn-sm" onclick="startScreening(' + patient.id + ')" title="Start Screening">' +
                        '<i class="fas fa-stethoscope"></i>' +
                    '</button>' +
                '</div>' +
            '</td>' +
        '</tr>';
    });
    
    console.log('Final HTML being inserted:', html);
    tbody.innerHTML = html;
}

function editPatient(patientId) {
    console.log('Editing patient:', patientId);
    
    fetch(`/health-assistant/api/get-patient/${patientId}/`)
        .then(response => {
            console.log('Get patient response:', response);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Patient data received:', data);
            if (data.error) {
                throw new Error(data.error);
            }
            const patient = data.patient;
            document.getElementById('editPatientId').value = patient.id;
            document.getElementById('editFirstName').value = patient.first_name;
            document.getElementById('editLastName').value = patient.last_name;
            document.getElementById('editDateOfBirth').value = patient.date_of_birth;
            document.getElementById('editGender').value = patient.gender;
            document.getElementById('editPhone').value = patient.phone_number;
            document.getElementById('editEmail').value = patient.email || '';
            document.getElementById('editCity').value = patient.city || '';
            document.getElementById('editAddress').value = patient.address || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editPatientModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading patient:', error);
            alert(`Error loading patient details: ${error.message}`);
        });
}

function updatePatient() {
    const patientId = document.getElementById('editPatientId').value;
    const formData = new FormData(document.getElementById('editPatientForm'));
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/health-assistant/api/patients/${patientId}/update/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editPatientModal'));
            modal.hide();
            
            // Show success message
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show';
            successAlert.innerHTML = `
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                Patient updated successfully!
            `;
            
            // Insert the alert after the card header
            const cardHeader = document.querySelector('.card-header');
            if (cardHeader) {
                cardHeader.insertAdjacentHTML('afterend', successAlert.outerHTML);
            }
            
            // Clear the URL parameters
            const newUrl = window.location.pathname;
            window.history.replaceState({}, '', newUrl);
            
            // Refresh the patient list to show updated data
            setTimeout(() => {
                loadPatients();
            }, 1000);
        } else {
            alert(`Error updating patient: ${data.error || 'Unknown error'}`);
        }
    })
    .catch(error => {
        console.error('Error updating patient:', error);
        alert(`Error updating patient: ${error.message}`);
    });
}

function startScreening(patientId) {
    window.location.href = `/health-assistant/screening/${patientId}/`;
}

function refreshPatients() {
    currentPage = 1;
    loadPatients();
}

function exportPatients() {
    const params = new URLSearchParams({
        q: currentQuery,
        gender: currentGender,
        date_from: currentDateFrom,
        date_to: currentDateTo,
        export: 'csv'
    });
    
    window.location.href = `/health-assistant/api/search-patients/?${params.toString()}`;
}

function updatePagination(pagination) {
    const paginationEl = document.getElementById('pagination');
    
    if (!pagination.total_pages || pagination.total_pages <= 1) {
        paginationEl.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    if (pagination.has_previous) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${pagination.previous_page})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;
    }
    
    // Page numbers
    for (let i = 1; i <= pagination.total_pages; i++) {
        const activeClass = i === pagination.current_page ? 'active' : '';
        paginationHTML += `
            <li class="page-item ${activeClass}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }
    
    // Next button
    if (pagination.has_next) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${pagination.next_page})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;
    }
    
    paginationEl.innerHTML = paginationHTML;
}

function changePage(page) {
    currentPage = page;
    loadPatients();
}

function updatePatientCount(count) {
    const countEl = document.getElementById('patientCount');
    if (count === 0) {
        countEl.textContent = 'No patients found';
    } else if (count === 1) {
        countEl.textContent = '1 patient found';
    } else {
        countEl.textContent = `${count} patients found`;
    }
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function showToast(message) {
    document.getElementById('toastMessage').textContent = message;
    const toast = new bootstrap.Toast(document.getElementById('successToast'));
    toast.show();
}
</script>
{% endblock %}
